import 'package:flutter/material.dart';
import '../models/car_model.dart';
import '../services/api_service.dart';
import 'car_details_screen.dart';

class CarsScreen extends StatefulWidget {
  final int cityId;

  const CarsScreen({super.key, required this.cityId});

  @override
  State<CarsScreen> createState() => _CarsScreenState();
}

class _CarsScreenState extends State<CarsScreen> {
  List<CarModel> cars = [];
  bool isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadCars();
  }

  // ðŸ”µ STEP 2.1 â€” LOAD AND CONVERT JSON TO MODEL
  Future<void> _loadCars() async {
    try {
      final data = await ApiService.getCarsByCity(widget.cityId);

      setState(() {
        cars = data.map<CarModel>((json) => CarModel.fromJson(json)).toList();
        isLoading = false;
      });
    } catch (e) {
      debugPrint("Error loading cars: $e");
      setState(() => isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey[200],
      appBar: AppBar(
        title: const Text("Cars Available"),
      ),

      body: isLoading
          ? const Center(child: CircularProgressIndicator())
          : cars.isEmpty
              ? const Center(
                  child: Text(
                    "No cars found",
                    style: TextStyle(fontSize: 20, color: Colors.grey),
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(16),
                  itemCount: cars.length,
                  itemBuilder: (context, index) {
                    final car = cars[index];

                    return GestureDetector(
                      onTap: () {
                        // ðŸ”µ STEP 2.3 â€” PASS CORRECT MODEL TO DETAILS SCREEN
                        Navigator.push(
                          context,
                          MaterialPageRoute(
                            builder: (_) => CarDetailsScreen(car: car),
                          ),
                        );
                      },

                      child: Container(
                        margin: const EdgeInsets.only(bottom: 16),
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(12),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black12,
                              blurRadius: 6,
                              offset: const Offset(0, 3),
                            )
                          ],
                        ),

                        child: Row(
                          children: [
                            // ðŸŸ¦ Car Image
                            ClipRRect(
                              borderRadius: BorderRadius.circular(10),
                              child: Image.network(
                                car.imageUrl,
                                height: 90,
                                width: 120,
                                fit: BoxFit.cover,
                                errorBuilder: (_, __, ___) =>
                                    const Icon(Icons.car_crash, size: 60),
                              ),
                            ),
                            const SizedBox(width: 14),

                            // ðŸŸ¦ Car Info
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    car.name,
                                    style: const TextStyle(
                                      fontSize: 18,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                  const SizedBox(height: 4),

                                  Text(
                                    car.brand,
                                    style: const TextStyle(
                                        fontSize: 14, color: Colors.grey),
                                  ),
                                  const SizedBox(height: 6),

                                  Text(
                                    "${car.pricePerDay.toStringAsFixed(0)} SAR / day",
                                    style: TextStyle(
                                      fontSize: 16,
                                      color: Colors.blue.shade700,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
    );
  }
}
